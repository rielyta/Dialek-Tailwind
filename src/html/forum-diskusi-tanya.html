<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dialek.id - Forum Diskusi</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles/style2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-custom-radial font-inter flex flex-col min-h-screen">
    <nav class="flex items-center justify-between w-full px-12 py-12">
        <div id="home" class="logo font-irish m-0 text-2xl cursor-pointer">dialek.id</div>
        <div id="profile-button" class="flex items-center m-0 font-semibold text-custom2 cursor-pointer">
            <p id="account-username" class="px-4 text-xl">memuat...</p>
            <i class="fa-solid fa-user text-2xl"></i> 
        </div>
    </nav>

    <main class="flex flex-col items-center flex-grow">
        <div class="flex items-center w-full justify-center mb-10">
            <h1 class="text-4xl font-bold text-gradient">Wadah Diskusi</h1>
        </div>

        <div class="flex items-start w-full px-12">
            <div class="mx-auto p-6 rounded-lg box-custom1 w-10/12 md:w-8/12 lg:w-6/12" style="background-color: rgba(212, 229, 221, 0.4);"> 
                <div class="flex space-x-2 mb-4">
                    <div class="button-custom flex items-center justify-center text-sm py-2 px-4 rounded-full bg-blue-500 text-white">Bahasa Batak Toba</div>
                </div>

                <label for="pertanyaanInput" class="text-lg font-semibold text-green-800">Tulis pertanyaanmu:</label>
                <textarea id="pertanyaanInput" class="w-full p-3 rounded-lg border-none focus:outline-none text-white" rows="5" placeholder="Ajukan pertanyaanmu di sini..." style="background-color: #4C968B;"></textarea>

                <div class="flex justify-end mt-2">
                    <button id="tanyaButton" class="bg-green-800 text-white py-2 px-4 rounded-full shadow-md hover:bg-green-700">Tanya</button>
                </div>
            </div>
        </div>

        <div class="mt-6 w-10/12 md:w-8/12 lg:w-6/12">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-semibold text-green-800">Pertanyaan Lain:</h2>
                <div class="flex space-x-1">
                    <button id="terbaruButton" class="button-custom2 text-white opacity-100">Terbaru</button>
                    <button id="popularButton" class="button-custom2 text-white">Popular</button>
                </div>
            </div>

            <div id="loading-container" class="text-center py-8 hidden">
                <span class="loading-spinner"></span> Memuat...
            </div>

            <div id="pertanyaanList" class="space-y-2"></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, updateDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCrmVDlBwRkkzP_rYY3mXBKw_ihrkV3tVM",
            authDomain: "dialek-6a219.firebaseapp.com",
            projectId: "dialek-6a219",
            storageBucket: "dialek-6a219.firebasestorage.app",
            messagingSenderId: "423916223695",
            appId: "1:423916223695:web:449bd44c54cad998d8cbba"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let pertanyaanArray = [];

        const elements = {
            input: document.getElementById('pertanyaanInput'),
            tanyaBtn: document.getElementById('tanyaButton'),
            list: document.getElementById('pertanyaanList'),
            loading: document.getElementById('loading-container'),
            terbaruBtn: document.getElementById('terbaruButton'),
            popularBtn: document.getElementById('popularButton')
        };

        await firebaseManager.postForumQuestion(
        userId,
        questionText,
        userPrivateKey
        );

        await firebaseManager.sendEncryptedMessage(
        senderUserId,
        recipientUserId,
        messageText,
        senderPrivateKey
        );

        const messages = await firebaseManager.getReceivedMessages(userId);
            for (const msg of messages) {
            const plaintext = await firebaseManager.decryptReceivedMessage(
                msg.encryptedContent,
                userPrivateKey,
                msg.senderId
            );
            console.log('Decrypted:', plaintext);
            }

        function showLoading(show) {
            elements.loading.classList.toggle('hidden', !show);
        }

        async function loadPertanyaan() {
            try {
                showLoading(true);
                const q = query(collection(db, 'forum_questions'), orderBy('created_at', 'desc'));
                const snapshot = await getDocs(q);
                
                pertanyaanArray = [];
                snapshot.forEach(doc => {
                    pertanyaanArray.push({ id: doc.id, ...doc.data() });
                });

                renderPertanyaan(pertanyaanArray);
            } catch (error) {
                console.error("Error loading:", error);
                alert("Gagal memuat pertanyaan: " + error.message);
            } finally {
                showLoading(false);
            }
        }

        function renderPertanyaan(array) {
            elements.list.innerHTML = '';
            
            if (!array.length) {
                elements.list.innerHTML = '<p class="text-gray-600 text-center py-8">Belum ada pertanyaan</p>';
                return;
            }

            array.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center p-3 rounded-lg shadow-md text-white cursor-pointer hover:shadow-lg';
                div.style.backgroundColor = '#4C968B';
                
                const text = (item.text || '').substring(0, 100);
                const likes = item.likes || 0;
                const answers = item.answers_count || 0;
                const liked = item.likedBy?.includes(currentUser?.uid);

                div.innerHTML = `
                    <img src="${item.userProfileImage || 'https://img.icons8.com/color/48/user.png'}" class="w-8 h-8 rounded-full mr-3 object-cover"/>
                    <div class="flex-grow">
                        <span class="font-semibold">${item.username || 'Anonymous'}</span>
                        <p class="text-sm">${text}${text.length >= 100 ? '...' : ''}</p>
                        <span class="text-xs text-gray-300">${new Date(item.created_at).toLocaleString('id-ID')}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-center">
                            <div class="text-xs">Jawaban</div>
                            <div class="font-bold">${answers}</div>
                        </div>
                        <button class="jawab-btn bg-green-800 py-1 px-3 rounded-full text-sm hover:bg-green-600">Jawab</button>
                        <button class="like-btn flex items-center gap-1" data-id="${item.id}" data-liked="${liked}">
                            <i class="fas fa-heart" style="${liked ? 'color:#ef4444' : ''}"></i>
                            <span>${likes}</span>
                        </button>
                    </div>
                `;

                div.querySelector('.jawab-btn').onclick = (e) => {
                    e.stopPropagation();
                    window.location.href = `forum-diskusi-jawab.html?questionId=${item.id}`;
                };

                div.querySelector('.like-btn').onclick = async (e) => {
                    e.stopPropagation();
                    if (!currentUser) return alert('Login dulu');
                    
                    const btn = e.currentTarget;
                    const isLiked = btn.dataset.liked === 'true';
                    const icon = btn.querySelector('i');
                    const span = btn.querySelector('span');
                    
                    try {
                        let newLikes = likes;
                        let newLikedBy = [...(item.likedBy || [])];
                        
                        if (isLiked) {
                            newLikes--;
                            newLikedBy = newLikedBy.filter(uid => uid !== currentUser.uid);
                            icon.style.color = '';
                            btn.dataset.liked = 'false';
                        } else {
                            newLikes++;
                            newLikedBy.push(currentUser.uid);
                            icon.style.color = '#ef4444';
                            btn.dataset.liked = 'true';
                        }

                        await updateDoc(doc(db, 'forum_questions', item.id), {
                            likes: newLikes,
                            likedBy: newLikedBy
                        });

                        span.textContent = newLikes;
                        item.likes = newLikes;
                        item.likedBy = newLikedBy;
                    } catch (error) {
                        console.error("Like error:", error);
                        alert("Gagal like: " + error.message);
                    }
                };

                div.onclick = () => window.location.href = `forum-diskusi-jawab.html?questionId=${item.id}`;
                elements.list.appendChild(div);
            });
        }

        elements.tanyaBtn.onclick = async () => {
            if (!currentUser) return alert('Login dulu');
            
            const text = elements.input.value.trim();
            if (!text) return alert('Tulis pertanyaan dulu');

            try {
                elements.tanyaBtn.disabled = true;
                elements.tanyaBtn.innerHTML = '<span class="loading-spinner"></span> Mengirim...';

                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const userData = userDoc.data();

                await addDoc(collection(db, 'forum_questions'), {
                    text,
                    userId: currentUser.uid,
                    username: userData?.username || 'Anonymous',
                    userProfileImage: userData?.profile_image || null,
                    likes: 0,
                    likedBy: [],
                    category: 'Bahasa Batak Toba',
                    created_at: new Date().toISOString(),
                    answers_count: 0
                });

                elements.input.value = '';
                alert('Pertanyaan berhasil diposting!');
                await loadPertanyaan();
            } catch (error) {
                console.error("Post error:", error);
                alert("Gagal posting: " + error.message);
            } finally {
                elements.tanyaBtn.disabled = false;
                elements.tanyaBtn.textContent = 'Tanya';
            }
        };

        elements.terbaruBtn.onclick = () => {
            const sorted = [...pertanyaanArray].sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );
            elements.terbaruBtn.classList.add('opacity-100');
            elements.popularBtn.classList.remove('opacity-100');
            renderPertanyaan(sorted);
        };

        elements.popularBtn.onclick = () => {
            const sorted = [...pertanyaanArray].sort((a, b) => 
                (b.likes || 0) - (a.likes || 0)
            );
            elements.popularBtn.classList.add('opacity-100');
            elements.terbaruBtn.classList.remove('opacity-100');
            renderPertanyaan(sorted);
        };

        document.getElementById('home').onclick = () => window.location.href = './dashboardBatak.html';
        document.getElementById('profile-button').onclick = () => window.location.href = './akun-pengguna.html';

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert('Login dulu');
                return window.location.href = './masuk.html';
            }

            currentUser = user;
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    document.getElementById('account-username').textContent = 
                        userDoc.data().username || 'User';
                }
                await loadPertanyaan();
            } catch (error) {
                console.error("Auth error:", error);
            }
        });
    </script>
</body>
</html>